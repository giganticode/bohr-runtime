name: pull_request
on: [pull_request]
jobs:
  b2b-tests:
    runs-on: self-hosted
    defaults:
      run:
        shell: bash -lieo pipefail {0}
        working-directory: /usr/src/bohr-runtime
    container: giganticode/bohr-cml-base:latest
    env:
      repo_token: ${{ secrets.GITHUB_TOKEN }}
      DVC_IRONSPEED_USERNAME: ${{ secrets.DVC_IRONSPEED_USERNAME }}
      DVC_IRONSPEED_PASSWORD: ${{ secrets.DVC_IRONSPEED_PASSWORD }}
      PYTHONPATH: /usr/src/bohr-runtime:/usr/src/bohr-runtime/test-b2b/labeling
      HOME: /root
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
    steps:
      - name: update-base-ref
        run: |
          git checkout $GITHUB_BASE_REF
          git pull
      - name: checkout-pull-request
        run: |
          PR_NUMBER=$(echo $GITHUB_REF | awk 'BEGIN { FS = "/" } ; { print $3 }')
          git fetch origin +pull/$PR_NUMBER/head:pr/$PR_NUMBER
          git checkout pr/$PR_NUMBER
      - name: build-image
        run: docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD && bash bin/update-docker.sh "origin/$GITHUB_BASE_REF"
      - name: install-dependencies
        run: |
          /root/.poetry/bin/poetry env info
          /root/.poetry/bin/poetry run pip install Cython==0.29.23
          export SKLEARN_NO_OPENMP=1 && /root/.poetry/bin/poetry install
          /root/.poetry/bin/poetry run bohr -h
      - name: unit-tests
        run: /root/.poetry/bin/poetry run pytest --doctest-modules --ignore=test-b2b
      - name: setup-dvc
        run: |
          /root/.poetry/bin/poetry run dvc --version
          cd /usr/src/bohr-runtime/test-b2b/labeling
          /root/.poetry/bin/poetry run dvc remote modify --local ironspeed-test user $DVC_IRONSPEED_USERNAME
          /root/.poetry/bin/poetry run dvc remote modify --local ironspeed-test password $DVC_IRONSPEED_PASSWORD
          /root/.poetry/bin/poetry run dvc config core.check_update false
      - name: reproduce-bugginess
        run: |
          cd /usr/src/bohr-runtime/test-b2b/labeling
          /root/.poetry/bin/poetry run bohr config paths.software_path /usr/src/tools
          /root/.poetry/bin/poetry run bohr config core.verbose false
          /root/.poetry/bin/poetry run bohr status
          /root/.poetry/bin/poetry run bohr repro bugginess-1k
          /root/.poetry/bin/poetry run bohr pull -v bugginess-1k berger
      - name: report-metrics
        run: |
          git fetch --prune
          cd /usr/src/bohr-runtime/test-b2b/labeling
          /root/.poetry/bin/poetry run dvc metrics diff master
          [ -z "$(/root/.poetry/bin/poetry run dvc metrics diff master)" ]
      - name: cli-commands
        run: |
          cd /usr/src/bohr-runtime/test-b2b/labeling
          touch /usr/src/new_dataset.csv
          /root/.poetry/bin/poetry run bohr dataset add /usr/src/new_dataset.csv -t commit
          /root/.poetry/bin/poetry run bohr task add sample-task -d desc -t commit -l TangledCommit.NonTangled,TangledCommit.Tangled -c bug --force --use-all-datasets
